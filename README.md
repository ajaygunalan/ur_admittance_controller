# ur_admittance_controller

6-DOF force-compliant motion control for Universal Robots with gravity compensation. See [docs/dependencies.md](docs/dependencies.md) for detailed package dependencies.


## Setup

Clone dependencies:
```bash
mkdir -p ~/ros2_ws/src && cd ~/ros2_ws/src
git clone https://github.com/ajaygunalan/ur_simulation_gz.git
git clone https://github.com/ajaygunalan/ur_admittance_controller.git
```

Install dependencies:
```bash
cd ~/ur_ws && rosdep install --from-paths src --ignore-src -r -y
```

Build simulation:
```bash
colcon build --packages-select ur_simulation_gz && source install/setup.bash
```

Build controller:
```bash
colcon build --packages-select ur_admittance_controller && source install/setup.bash
```

Build force sensor driver (if using hardware):
```bash
colcon build --packages-select net_ft_driver net_ft_diagnostic_broadcaster && source install/setup.bash
```

## Usage

### Simulation

Launch robot:
```bash
ros2 launch ur_simulation_gz ur_sim_control.launch.py ur_type:=ur5e
```

### Hardware

**Prerequisites:**
- [Universal_Robots_ROS2_Driver](https://github.com/UniversalRobots/Universal_Robots_ROS2_Driver)
- [ros2_net_ft_driver](https://github.com/gbartyzel/ros2_net_ft_driver)

Launch robot and force sensor:
```bash
# Terminal 1: Launch UR5e driver
ros2 launch ur_robot_driver ur_control.launch.py \
  ur_type:=ur5e robot_ip:=<ROBOT_IP> \
  kinematics_params_file:="$HOME/ur5e_calibration.yaml"

# Terminal 2: Launch force sensor (with topic remapping)
ros2 launch net_ft_driver net_ft_broadcaster.launch.py \
  ip_address:=169.254.120.10 sensor_type:=ati \
  --ros-args -r ft_data:=netft/data
```

**Note:** Generate calibration file once with:
```bash
ros2 launch ur_calibration calibration_correction.launch.py \
  robot_ip:=<ROBOT_IP> target_filename:="$HOME/ur5e_calibration.yaml"
```

Test robot connection:
```bash
ros2 run ur_robot_driver example_move.py
```

Initialize to equilibrium:
```bash
ros2 run ur_admittance_controller init_robot
```

Run calibration (one-time):
```bash
ros2 run ur_admittance_controller wrench_calibration_node
```

Switch controller:
```bash
ros2 control switch_controllers --deactivate scaled_joint_trajectory_controller --activate forward_velocity_controller
```

Start wrench node:
```bash
ros2 run ur_admittance_controller wrench_node
```

Start admittance node:
```bash
ros2 run ur_admittance_controller admittance_node
```

### Force-Torque Topics

Quick checks while the wrench pipeline is running:
```bash
ros2 topic echo /netft/raw_sensor --once
ros2 topic echo /netft/proc_sensor --once
ros2 topic echo /netft/proc_probe --once
ros2 run ur_admittance_controller init_robot
```
- `/netft/raw_sensor` streams the unfiltered wrench directly from the NetFT driver (sensor frame).
- `/netft/proc_sensor` publishes the low-pass filtered, gravity/bias compensated wrench (still in the sensor frame).
- `/netft/proc_probe` mirrors the compensated wrench after transforming it into the probe/tool frame.

## Architecture

```
[F/T Sensor] → [Wrench Node] → [Admittance Node] → [Robot]
                     ↓                ↓                ↓
            (Gravity Compensation) (M·ẍ+D·ẋ+K·x=F) (Velocity Commands)
```

### Core Components

- Init Robot: Moves to equilibrium, saves pose to config
- Wrench Calibration: Estimates gravity/bias parameters (LROM method)  
- Wrench Node: Compensates F/T data for gravity and transforms to base frame
- Admittance Node: Implements admittance control law, outputs joint velocities

### Key Files

- `config/equilibrium.yaml` - Robot equilibrium pose (generated by init_robot)
- `config/wrench_calibration.yaml` - Calibration parameters (generated by calibration)
- `config/admittance_config.yaml` - Control parameters (M/K/D matrices)

### Tips

See [docs/debugging.md](docs/debugging.md) for debugging with VS Code.
